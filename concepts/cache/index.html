
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../bricks/">
      
      
        <link rel="next" href="../database_session/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Caching - Brickworks</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Source Sans Pro";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#caching" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Brickworks" class="md-header__button md-logo" aria-label="Brickworks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Brickworks
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Caching
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jens-kuerten/brickworks" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Brickworks

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../bricks/" class="md-tabs__link">
          
  
  
  Concepts

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Brickworks" class="md-nav__button md-logo" aria-label="Brickworks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Brickworks
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jens-kuerten/brickworks" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Brickworks
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bricks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bricks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Caching
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Caching
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Initialization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tenancy" class="md-nav__link">
    <span class="md-ellipsis">
      Tenancy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-value-caching" class="md-nav__link">
    <span class="md-ellipsis">
      Key-Value Caching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key-Value Caching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Set a Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Get a Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Delete a Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      Refresh Expiration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queue-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Queue Operations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queue Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#push-to-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Push to Queue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pop-from-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Pop from Queue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed-locking" class="md-nav__link">
    <span class="md-ellipsis">
      Distributed Locking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Distributed Locking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acquire-a-lock" class="md-nav__link">
    <span class="md-ellipsis">
      Acquire a Lock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#release-a-lock" class="md-nav__link">
    <span class="md-ellipsis">
      Release a Lock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-cache-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      Function Cache Decorator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-and-listing-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Indexing and Listing Keys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache-consistency-and-post-commit-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      Cache Consistency and Post-commit Callbacks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database_session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../view_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Views Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../access_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Access Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../routing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Routing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Initialization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tenancy" class="md-nav__link">
    <span class="md-ellipsis">
      Tenancy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-value-caching" class="md-nav__link">
    <span class="md-ellipsis">
      Key-Value Caching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key-Value Caching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Set a Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Get a Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Delete a Value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#refresh-expiration" class="md-nav__link">
    <span class="md-ellipsis">
      Refresh Expiration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queue-operations" class="md-nav__link">
    <span class="md-ellipsis">
      Queue Operations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queue Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#push-to-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Push to Queue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pop-from-queue" class="md-nav__link">
    <span class="md-ellipsis">
      Pop from Queue
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distributed-locking" class="md-nav__link">
    <span class="md-ellipsis">
      Distributed Locking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Distributed Locking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acquire-a-lock" class="md-nav__link">
    <span class="md-ellipsis">
      Acquire a Lock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#release-a-lock" class="md-nav__link">
    <span class="md-ellipsis">
      Release a Lock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-cache-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      Function Cache Decorator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-and-listing-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Indexing and Listing Keys
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache-consistency-and-post-commit-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      Cache Consistency and Post-commit Callbacks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      Example
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="caching">Caching</h1>
<p>The <code>BrickworksCache</code> class provides a unified interface for caching in memory or Redis, supporting both key-value and queue-based operations, as well as distributed locking and an async function cache decorator.
The cache is fully async, meaning you can NOT use it from within syncronous functions!</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The memory version is only ment for running tests without having Redis available. Do NOT use the memory version for production as it is not shared between multiple replicas of your application and might leak memory!</p>
</div>
<p>The Redis connection can be configured with the following environment variables:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>USE_REDIS = &quot;1&quot;
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>REDIS_HOST = &quot;localhost&quot;
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>REDIS_PORT = &quot;6379&quot;
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>REDIS_DB = &quot;0&quot;
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>REDIS_PASSWORD = &quot;&quot;
</code></pre></div>
<h2 id="initialization">Initialization</h2>
<p>The cache is available as a singleton:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">brickworks.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>
</code></pre></div>
<h2 id="tenancy">Tenancy</h2>
<p>All cache operations are tenant-aware. By default, operations are scoped to the current tenant.
If you want to cache something "globaly" accross tenants, pass the parameter <code>master_tenant=True</code> to the get or set methods.</p>
<h2 id="key-value-caching">Key-Value Caching</h2>
<h3 id="set-a-value">Set a Value</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">set_key</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">,</span> <span class="s2">&quot;myvalue&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>key</code>: The cache key (string)</li>
<li><code>value</code>: The value to store (string)</li>
<li><code>namespace</code>: Optional, default is "default" - set a namespace to prevent key collisions</li>
<li><code>expire</code>: Expiration in seconds (default: 7 days)</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Keys and namespaces must not contain a colon (:)!</p>
</div>
<h3 id="get-a-value">Get a Value</h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">value</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
</code></pre></div>
Returns the string value or <code>None</code> if not found or expired.</p>
<h3 id="delete-a-value">Delete a Value</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">delete_key</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can only cache string values! If you need to store other data types, either convert them to string, or serialize them with e.g. json.</p>
</div>
<h3 id="refresh-expiration">Refresh Expiration</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">refresh_key</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
</code></pre></div>
<h2 id="queue-operations">Queue Operations</h2>
<h3 id="push-to-queue">Push to Queue</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">push_to_queue</span><span class="p">(</span><span class="s2">&quot;queue_name&quot;</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="pop-from-queue">Pop from Queue</h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">pop_from_queue</span><span class="p">(</span><span class="s2">&quot;queue_name&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
</code></pre></div>
Returns the next item (string) or <code>None</code> if the queue is empty.</p>
<h2 id="distributed-locking">Distributed Locking</h2>
<p>Distributed locks are mainly intended for coordinating background services in environments with multiple app replicas. For example, if you deploy several instances of your app, a background service (such as one sending email notifications) might run in every replica. Without coordination, this could result in duplicate work (e.g., multiple emails sent for the same event).</p>
<p>To prevent this, a service can attempt to acquire a distributed lock before performing an operation. If the lock is acquired, the service proceeds; if not, it skips the operation, knowing another replica is already handling it. The <code>ttl</code> parameter ensures that if a service or replica crashes and doesn't release the lock, the lock will eventually expire and allow another replica to take over.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using distributed locks for coordinating between processes or replicas only works if you use Redis as a backend!</p>
</div>
<h3 id="acquire-a-lock">Acquire a Lock</h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">attempt_distributed_lock</span><span class="p">(</span><span class="s2">&quot;lock_name&quot;</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
Returns <code>True</code> if the lock was acquired.</p>
<ul>
<li><code>ttl</code>: The time-to-live (expiration) for the lock in seconds.</li>
</ul>
<h3 id="release-a-lock">Release a Lock</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">release_distributed_lock</span><span class="p">(</span><span class="s2">&quot;lock_name&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="function-cache-decorator">Function Cache Decorator</h2>
<p>You can cache the results of async functions with JSON-serializable arguments and pickleable return values:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nd">@cache</span><span class="o">.</span><span class="n">func_cache</span><span class="p">(</span><span class="n">expire</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="o">...</span>
</code></pre></div>
<p>And clear the cache with:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">await</span> <span class="n">compute</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
</code></pre></div>
<p>Note: the cache is only cleared for the currently active tenant!</p>
<p>There are a few key differences between <code>functools.func_cache</code> and Brickworks <code>cache.func_cache</code></p>
<ul>
<li><strong>Tenant Awareness:</strong> The Brickworks cache is tenant-aware, so results are isolated per tenant by default.</li>
<li><strong>Distributed Cache:</strong> If enabled, the Brickworks cache is stored in Redis. This enables multiple replicas of the application to share the same cache.</li>
<li><strong>Time based expire:</strong> Cached results expire automatically after a certain time. (default 1 week)</li>
<li><strong>Async only:</strong> Brickworks func_cache only works with async functions, because otherwise the async redis connection could not be used</li>
</ul>
<h2 id="indexing-and-listing-keys">Indexing and Listing Keys</h2>
<p>The Brickworks cache supports indexing, which allows you to group related cache keys under a named index. This is useful when you want to efficiently list or manage all keys associated with a particular group (for example, all cache entries related to a specific resource type).</p>
<p>When you set a key, you can specify one or more indices:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">set_key</span><span class="p">(</span><span class="s2">&quot;user-123&quot;</span><span class="p">,</span> <span class="s2">&quot;userdata 123&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">set_key</span><span class="p">(</span><span class="s2">&quot;user-456&quot;</span><span class="p">,</span> <span class="s2">&quot;userdata 456&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">])</span>
</code></pre></div>
<p>You can then list all keys associated with an index:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">user_keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">list_keys_by_index</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># user_keys will be [&quot;user-123&quot;, &quot;user-456&quot;]</span>
</code></pre></div>
<p>If you delete a key, it is automatically removed from the index. Indices are tenant-aware, so each tenant has its own set of indices and indexed keys.</p>
<p>This feature is especially useful for cache invalidation or performing bulk operations on related cache entries, where you would otherwise need to use the Redis <code>SCAN</code> command to find related keys.</p>
<h2 id="cache-consistency-and-post-commit-callbacks">Cache Consistency and Post-commit Callbacks</h2>
<p>When your cache depends on the state of the database (for example, when caching the results of a query or storing metadata about database objects), you should only update or invalidate the cache after the database transaction has been successfully committed. Otherwise, if the transaction is rolled back, your cache could become inconsistent with the actual database state.</p>
<p>Brickworks supports post-commit callbacks for this purpose. You can register a cache update or invalidation function to be called after a successful commit:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">brickworks.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">cache</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_cache</span><span class="p">():</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">delete_key</span><span class="p">(</span><span class="s2">&quot;mykey&quot;</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="c1"># Register the callback inside a session context</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">db</span><span class="o">.</span><span class="n">add_post_commit_callback</span><span class="p">(</span><span class="n">invalidate_cache</span><span class="p">)</span>
</code></pre></div>
<p>This ensures that the cache is only updated if the database changes are actually persisted. See the <a href="../database_session/#post-commit-callbacks">Database Session documentation</a> for more details.</p>
<h2 id="example">Example</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Set and get a value</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">set_key</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">val</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># Use as a queue</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">push_to_queue</span><span class="p">(</span><span class="s2">&quot;myqueue&quot;</span><span class="p">,</span> <span class="s2">&quot;item1&quot;</span><span class="p">)</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">pop_from_queue</span><span class="p">(</span><span class="s2">&quot;myqueue&quot;</span><span class="p">)</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="c1"># Use the func cache decorator</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="nd">@cache</span><span class="o">.</span><span class="n">func_cache</span><span class="p">(</span><span class="n">expire</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="k">await</span> <span class="n">add</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.tabs", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.preview", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.top", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>